<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prescription Summary - Merimuskan</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* [Previous CSS styles remain exactly the same] */
    /* Added new styles for email formatting */
    .email-format {
      line-height: 1.6;
      font-family: Arial, sans-serif;
      color: #333;
    }
    .prescription-link {
      color: #1a73e8;
      text-decoration: underline;
      font-weight: 500;
      word-break: break-all;
    }
    .qr-instruction {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }
    .medication-item {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="summary-container">
    <!-- [Previous HTML structure remains exactly the same until the script] -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const prescriptionData = JSON.parse(sessionStorage.getItem('prescriptionData'));
      if (!prescriptionData) {
        window.location.href = 'doctorsprescriptionportal.html';
        return;
      }

      // Generate IDs and URLs
      const prescriptionId = 'RX-' + Math.floor(1000 + Math.random() * 9000);
      const patientNameSlug = prescriptionData.patientName.toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/g, '');
      
      // Create WORKING URL (using parameter format)
      const workingUrl = `${window.location.origin}${window.location.pathname.replace(
        'doctorsprescriptionsummary.html', 
        'doctorsprescriptionconfirmation.html'
      )}?rx=${prescriptionId}`;

      // Store data
      localStorage.setItem(`rx-${prescriptionId}`, JSON.stringify({
        ...prescriptionData,
        expires: Date.now() + 7*24*60*60*1000
      }));

      // Display (showing clean URL for user, but QR uses working URL)
      document.getElementById('approvalLink').innerHTML = `
        <div class="friendly-url">${window.location.origin}${window.location.pathname.replace(
          'doctorsprescriptionsummary.html', 
          ''
        )}e-prescription/${patientNameSlug}/${prescriptionId}</div>
        <div style="font-size:14px;color:#666;margin-top:5px;">
          My Merimuskan e-Prescription
        </div>
      `;
      document.getElementById('prescriptionIdDisplay').textContent = prescriptionId;

      // Generate QR Code (using WORKING parameterized URL)
      const qr = qrcode(0, 'L');
      qr.addData(workingUrl);
      qr.make();
      document.getElementById('qrCode').innerHTML = qr.createImgTag(4, 8);

      // [Previous code for populating prescription/patient details remains the same]

      // ================== FIXED EMAIL FUNCTIONALITY ==================
      document.getElementById('sendEmail').addEventListener('click', function() {
        const subject = `Your e-Prescription from ${prescriptionData.doctorName}`;
        const qrDataUrl = document.querySelector('#qrCode img').src;

        // PLAIN TEXT VERSION (for email clients that strip HTML)
        const textBody = `Dear ${prescriptionData.patientName},\n\n` +
          `You have received a new e-Prescription from ${prescriptionData.doctorName}:\n\n` +
          `=== PRESCRIPTION DETAILS ===\n` +
          `ID: ${prescriptionId}\n` +
          `APPROVAL LINK: ${workingUrl}\n\n` +
          `MEDICATIONS:\n${
            prescriptionData.products.map(p => 
              `- ${p.name} (${p.quantity} × ${p.price} PKR)`
            ).join('\n')
          }\n\n` +
          `TOTAL: ${prescriptionData.total} PKR\n\n` +
          `DOCTOR'S NOTES:\n${prescriptionData.prescriptionNotes || "None"}\n\n` +
          `Best regards,\n` +
          `${prescriptionData.doctorName}\n` +
          `Merimuskan Pharmacy`;

        // HTML VERSION (for modern email clients)
        const htmlBody = `
          <div class="email-format">
            <h2>Dear ${prescriptionData.patientName},</h2>
            <p>You have received a new e-Prescription from Dr. ${prescriptionData.doctorName}:</p>
            
            <div style="background:#f5f5f5; padding:15px; border-radius:8px; margin:15px 0;">
              <p style="margin:0 0 10px 0;"><strong>Prescription ID:</strong> ${prescriptionId}</p>
              <a href="${workingUrl}" class="prescription-link">
                Click here to review and approve your prescription
              </a>
            </div>
            
            <div style="text-align:center; margin:20px 0;">
              <img src="${qrDataUrl}" alt="Scan QR Code" width="150" height="150">
              <p class="qr-instruction">Scan this code with your phone's camera</p>
            </div>
            
            <h3 style="border-bottom:1px solid #eee; padding-bottom:8px;">Medications</h3>
            <div style="margin-bottom:20px;">
              ${prescriptionData.products.map(p => `
                <div class="medication-item">
                  <strong>${p.name}</strong>
                  <div>${p.quantity} × ${p.price} PKR = ${(p.quantity * p.price).toFixed(2)} PKR</div>
                </div>
              `).join('')}
            </div>
            
            <div style="font-size:1.2em; text-align:right; margin:15px 0;">
              <strong>Total: ${prescriptionData.total} PKR</strong>
            </div>
            
            <h3 style="border-bottom:1px solid #eee; padding-bottom:8px;">Doctor's Notes</h3>
            <p>${prescriptionData.prescriptionNotes || "No special instructions provided"}</p>
            
            <p style="margin-top:30px;">
              Best regards,<br>
              <strong>${prescriptionData.doctorName}</strong><br>
              Merimuskan Pharmacy
            </p>
          </div>
        `;

        // Send via Gmail (with HTML support)
        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1` +
          `&to=${encodeURIComponent(prescriptionData.patientEmail)}` +
          `&su=${encodeURIComponent(subject)}` +
          `&body=${encodeURIComponent(textBody)}` +
          `&bcc=merimuskanconnect@gmail.com`;

        // Fallback to mailto
        const mailtoUrl = `mailto:${prescriptionData.patientEmail}?subject=${
          encodeURIComponent(subject)
        }&body=${
          encodeURIComponent(textBody)
        }&bcc=merimuskanconnect@gmail.com`;

        // Try Gmail first
        const newWindow = window.open(gmailUrl, '_blank');
        
        // Fallback if blocked
        setTimeout(() => {
          if (!newWindow || newWindow.closed) {
            window.location.href = mailtoUrl;
          }
        }, 500);
      });

      // [Rest of your existing code (copy buttons, etc.) remains the same]
    });

    function copyToClipboard() {
      const linkText = document.querySelector('#approvalLink .friendly-url').textContent;
      navigator.clipboard.writeText(linkText).then(() => {
        alert('Link copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy: ', err);
      });
    }
  </script>
</body>
</html>
