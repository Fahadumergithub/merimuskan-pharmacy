<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [Keep all meta tags and styles from previous version] -->
  <style>
    /* Add this new style for email-specific formatting */
    .email-format {
      line-height: 1.6;
      font-family: Arial, sans-serif;
      color: #333;
    }
    .prescription-link {
      color: #1a73e8;
      text-decoration: underline;
      font-weight: 500;
      word-break: break-all;
    }
    .qr-instruction {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>
  <!-- [Keep all existing HTML structure] -->

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // [Keep all existing initialization code until approvalLink]

      // Generate QR code with absolute URL
      const qr = qrcode(0, 'L');
      const qrUrl = `${window.location.origin}${window.location.pathname.replace(
        'doctorsprescriptionsummary.html', 
        'doctorsprescriptionconfirmation.html'
      )}?rx=${prescriptionId}`;
      
      qr.addData(qrUrl);
      qr.make();
      document.getElementById('qrCode').innerHTML = qr.createImgTag(4, 8);

      // Email generation with improved formatting
      document.getElementById('sendEmail').addEventListener('click', function() {
        const subject = `Your e-Prescription from ${prescriptionData.doctorName}`;
        const qrDataUrl = document.querySelector('#qrCode img').src;

        // Plain text version with clickable link
        const textBody = `Dear ${prescriptionData.patientName},\n\n` +
          `You have received a new e-Prescription from ${prescriptionData.doctorName}:\n\n` +
          `Prescription ID: ${prescriptionId}\n` +
          `View your prescription: ${qrUrl}\n\n` +
          `Medications:\n${
            prescriptionData.products.map(p => 
              `- ${p.name} (${p.quantity} × ${p.price} PKR)`
            ).join('\n')
          }\n\n` +
          `Total: ${prescriptionData.total} PKR\n\n` +
          `Doctor's Notes: ${prescriptionData.prescriptionNotes || "None"}\n\n` +
          `Best regards,\n` +
          `${prescriptionData.doctorName}\n` +
          `Merimuskan Pharmacy`;

        // HTML version with styling
        const htmlBody = `
          <div class="email-format">
            <h2>Dear ${prescriptionData.patientName},</h2>
            <p>You have received a new e-Prescription from ${prescriptionData.doctorName}:</p>
            
            <p><strong>Prescription ID:</strong> ${prescriptionId}</p>
            
            <p>
              <a href="${qrUrl}" class="prescription-link">
                View your prescription
              </a>
            </p>
            
            <div style="margin: 20px 0;">
              <img src="${qrDataUrl}" alt="Scan QR Code" style="width: 150px; height: 150px;">
              <p class="qr-instruction">Scan this QR code with your phone's camera</p>
            </div>
            
            <h3>Medications:</h3>
            <ul>
              ${prescriptionData.products.map(p => 
                `<li>${p.name} (${p.quantity} × ${p.price} PKR)</li>`
              ).join('')}
            </ul>
            
            <p><strong>Total: ${prescriptionData.total} PKR</strong></p>
            
            <h3>Doctor's Notes:</h3>
            <p>${prescriptionData.prescriptionNotes || "None provided"}</p>
            
            <p>Best regards,<br>
            ${prescriptionData.doctorName}<br>
            Merimuskan Pharmacy</p>
          </div>
        `;

        // Send using mailto as fallback
        const mailtoUrl = `mailto:${prescriptionData.patientEmail}?subject=${
          encodeURIComponent(subject)
        }&body=${
          encodeURIComponent(textBody)
        }&bcc=merimuskanconnect@gmail.com`;

        // Try Gmail first
        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1` +
          `&to=${encodeURIComponent(prescriptionData.patientEmail)}` +
          `&su=${encodeURIComponent(subject)}` +
          `&body=${encodeURIComponent(textBody)}` +
          `&bcc=merimuskanconnect@gmail.com`;

        const newWindow = window.open(gmailUrl, '_blank');
        
        setTimeout(() => {
          if (!newWindow || newWindow.closed) {
            window.location.href = mailtoUrl;
          }
        }, 500);
      });
    });
  </script>
</body>
</html>
