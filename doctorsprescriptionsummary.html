<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
  // Helper functions for URL-safe encoding
  function makeUrlSafe(base64) {
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  document.addEventListener('DOMContentLoaded', function() {
    const prescriptionData = JSON.parse(sessionStorage.getItem('prescriptionData'));
    if (!prescriptionData) {
      window.location.href = 'doctorsprescriptionportal.html';
      return;
    }

    // Add expiration date (7 days from now)
    const expirationDate = new Date();
    expirationDate.setDate(expirationDate.getDate() + 7);
    prescriptionData.expires = expirationDate.getTime();

    // Generate URL with all prescription data encoded
    const jsonString = JSON.stringify(prescriptionData);
    const encodedData = makeUrlSafe(btoa(encodeURIComponent(jsonString)));
    const baseUrl = window.location.href.split('/').slice(0, -1).join('/') + '/';
    const approvalLink = `${baseUrl}doctorsprescriptionconfirmation.html?rx=${encodedData}`;

    // Display the actual link in the page (for copying)
    document.getElementById('approvalLink').textContent = approvalLink;

    // Generate QR Code
    const qr = qrcode(0, 'L');
    qr.addData(approvalLink);
    qr.make();
    const qrCodeImg = qr.createImgTag(4);
    document.getElementById('qrCode').innerHTML = qrCodeImg;
    const qrCodeSrc = qrCodeImg.match(/src="([^"]*)"/)[1];

    // OPG Checkbox functionality
    const opgCheckbox = document.getElementById('opgCheckbox');
    const opgDiscountContent = document.getElementById('opgDiscountContent');
    
    opgCheckbox.addEventListener('change', function() {
      opgDiscountContent.style.display = this.checked ? 'block' : 'none';
      if (this.checked) {
        const opgImage = opgDiscountContent.querySelector('img');
        opgImage.src = "https://raw.githubusercontent.com/Fahadumergithub/merimuskan-pharmacy/main/OpgDiscount.png";
      }
    });

    // Populate prescription details (keep your existing code)
    document.getElementById('prescriptionDetails').innerHTML = `
      <div class="info-row"><div class="info-label">Doctor:</div><div class="info-value">${prescriptionData.doctorName}</div></div>
      <div class="info-row"><div class="info-label">Issued Date:</div><div class="info-value">${new Date(prescriptionData.issuedDate).toLocaleDateString()}</div></div>
      <div class="info-row"><div class="info-label">Notes:</div><div class="info-value">${prescriptionData.prescriptionNotes}</div></div>
    `;

    // Populate patient details (keep your existing code)
    document.getElementById('patientDetails').innerHTML = `
      <div class="info-row"><div class="info-label">Name:</div><div class="info-value">${prescriptionData.patientName}</div></div>
      <div class="info-row"><div class="info-label">Phone:</div><div class="info-value">${prescriptionData.patientPhone}</div></div>
      <div class="info-row"><div class="info-label">Email:</div><div class="info-value">${prescriptionData.patientEmail}</div></div>
      <div class="info-row"><div class="info-label">Address:</div><div class="info-value">${prescriptionData.patientAddress}</div></div>
    `;

    // Populate prescription items (keep your existing code)
    const prescriptionItems = document.getElementById('prescriptionItems');
    prescriptionData.products.forEach(product => {
      const itemTotal = (product.price * product.quantity).toFixed(2);
      prescriptionItems.innerHTML += `
        <div class="product-item">
          <div><strong>${product.name}</strong><div>${product.quantity} × ${product.price} PKR</div></div>
          <div>${itemTotal} PKR</div>
        </div>
      `;
    });

    document.getElementById('prescriptionTotal').textContent = prescriptionData.total;

    // Updated Email Integration with masked links
    document.getElementById('sendEmail').addEventListener('click', function() {
      const opgChecked = opgCheckbox.checked;
      const subject = `Your Prescription from ${prescriptionData.doctorName}`;
      
      // Create HTML email body with masked link
      let body = `
        <html>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto;">
          <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
            <h2 style="color: #2C3345; margin-top: 0;">Prescription Ready for Review</h2>
            
            <p>Dear ${prescriptionData.patientName},</p>
            
            <p>Dr. ${prescriptionData.doctorName} has prepared your prescription. Please review and approve it at your earliest convenience.</p>
            
            <div style="text-align: center; margin: 25px 0;">
              <a href="${approvalLink}" style="background-color: #4299e1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold; display: inline-block;">
                View Your Prescription
              </a>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 6px; margin: 20px 0;">
              <h3 style="margin-top: 0;">Prescription Summary</h3>
              <ul style="padding-left: 20px; list-style-type: none;">
                ${prescriptionData.products.map(p => 
                  `<li style="margin-bottom: 8px;">• ${p.name} <small>(${p.quantity} × ${p.price} PKR)</small></li>`
                ).join('')}
              </ul>
              <p style="text-align: right; font-weight: bold; border-top: 1px solid #eee; padding-top: 10px;">
                Total: ${prescriptionData.total} PKR
              </p>
            </div>
            
            ${prescriptionData.prescriptionNotes ? `
            <div style="background: #f0f7ff; padding: 15px; border-radius: 6px; margin: 15px 0; border-left: 4px solid #4299e1;">
              <h4 style="margin-top: 0;">Doctor's Notes</h4>
              <p>${prescriptionData.prescriptionNotes}</p>
            </div>
            ` : ''}
            
            ${opgChecked ? `
            <div style="background: #fff8e6; padding: 15px; border-radius: 6px; margin: 15px 0; border-left: 4px solid #ffc107;">
              <h4 style="margin-top: 0;">OPG X-Ray Recommended</h4>
              <p>Your prescription includes an OPG X-Ray service. Please present this coupon at our imaging center:</p>
              <img src="https://raw.githubusercontent.com/Fahadumergithub/merimuskan-pharmacy/main/OpgDiscount.png" alt="OPG Discount" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            ` : ''}
            
            <div style="text-align: center; margin-top: 30px;">
              <small style="color: #666;">This prescription link will expire on ${expirationDate.toLocaleDateString()}</small>
            </div>
          </div>
          
          <p style="text-align: center; color: #666; margin-top: 20px;">
            <small>Merimuskan Pharmacy • ${new Date().getFullYear()}</small>
          </p>
        </body>
        </html>
      `;

      // Plain text fallback with direct link
      let plainTextBody = `Prescription from Dr. ${prescriptionData.doctorName}\n\n`
        + `Dear ${prescriptionData.patientName},\n\n`
        + `Please review your prescription at this link:\n${approvalLink}\n\n`
        + `Medications:\n${
          prescriptionData.products.map(p => 
            `- ${p.name} (${p.quantity} × ${p.price} PKR)`
          ).join('\n')
        }\n\n`
        + `Total: ${prescriptionData.total} PKR\n\n`
        + (prescriptionData.prescriptionNotes ? `Doctor's Notes: ${prescriptionData.prescriptionNotes}\n\n` : '')
        + (opgChecked ? `OPG X-Ray Recommended - Discount coupon available at: https://raw.githubusercontent.com/Fahadumergithub/merimuskan-pharmacy/main/OpgDiscount.png\n\n` : '')
        + `This link expires on ${expirationDate.toLocaleDateString()}\n\n`
        + `Merimuskan Pharmacy`;

      // Prepare email
      const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1` +
        `&to=${encodeURIComponent(prescriptionData.patientEmail)}` +
        `&su=${encodeURIComponent(subject)}` +
        `&body=${encodeURIComponent(plainTextBody)}` +
        `&bcc=merimuskanconnect@gmail.com`;

      // Try to open Gmail
      const newWindow = window.open(gmailUrl, '_blank');
      
      // Fallback to mailto
      setTimeout(() => {
        if (!newWindow || newWindow.closed) {
          window.location.href = `mailto:${prescriptionData.patientEmail}?subject=${
            encodeURIComponent(subject)
          }&body=${
            encodeURIComponent(plainTextBody)
          }&bcc=merimuskanconnect@gmail.com`;
        }
      }, 500);
    });

    // [Keep your existing copy functions unchanged]
    document.getElementById('copyAllDetails').addEventListener('click', function() {
      const opgChecked = opgCheckbox.checked;
      const text = `PRESCRIPTION DETAILS\n\nPatient: ${prescriptionData.patientName}\n\n` +
        `APPROVAL LINK:\n${approvalLink}\n\n` +
        `MEDICATIONS:\n${
          prescriptionData.products.map(p => 
            `- ${p.name} (${p.quantity} × ${p.price} PKR)`
          ).join('\n')
        }\n\n` +
        `TOTAL: ${prescriptionData.total} PKR\n\n` +
        (prescriptionData.prescriptionNotes ? `NOTES: ${prescriptionData.prescriptionNotes}\n\n` : '') +
        (opgChecked ? `OPG X-RAY INCLUDED\nCoupon: https://raw.githubusercontent.com/Fahadumergithub/merimuskan-pharmacy/main/OpgDiscount.png\n\n` : '') +
        `Prescribed by: ${prescriptionData.doctorName}\n` +
        `Expires: ${expirationDate.toLocaleDateString()}`;
      
      navigator.clipboard.writeText(text)
        .then(() => alert('All details copied to clipboard!'))
        .catch(err => console.error('Copy failed:', err));
    });

    function copyToClipboard() {
      const linkText = document.getElementById('approvalLink').textContent;
      navigator.clipboard.writeText(linkText).then(() => {
        alert('Link copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy: ', err);
      });
    }
  });
</script>
